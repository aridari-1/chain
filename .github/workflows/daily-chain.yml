name: Daily Global Chain (Rolling 24h)

on:
  schedule:
    # Runs every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  create-chain-and-clean-old:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

    steps:
      - name: Fetch latest global chain
        id: latest
        run: |
          set -e
          echo "üîç Fetching the latest active global chain..."
          LATEST_JSON=$(curl -fsS \
            "$SUPABASE_URL/rest/v1/chains?type=eq.global&order=created_at.desc&limit=1" \
            -H "apikey: $SERVICE_KEY" \
            -H "Authorization: Bearer $SERVICE_KEY" \
            -H "Accept: application/json")
          echo "latest_json=$LATEST_JSON" >> $GITHUB_OUTPUT
          echo "‚úÖ Latest chain fetched."

      - name: Determine if we need to create a new chain
        id: decide
        run: |
          set -e
          latest_json='${{ steps.latest.outputs.latest_json }}'
          node -e "
            const data = ${latest_json || '[]'};
            const latest = Array.isArray(data) && data[0] ? data[0] : null;
            const needsNew = (() => {
              if (!latest) return true;
              const createdAt = new Date(latest.created_at).getTime();
              const now = Date.now();
              return (now - createdAt) >= 24 * 60 * 60 * 1000;
            })();
            const id = latest?.id || '';
            console.log('needsNew=' + needsNew);
            console.log('currentId=' + id);
          " | tee decide.log

          NEEDS_NEW=$(grep '^needsNew=' decide.log | cut -d= -f2)
          CURR_ID=$(grep '^currentId=' decide.log | cut -d= -f2)
          echo "needs_new=$NEEDS_NEW" >> $GITHUB_OUTPUT
          echo "current_id=$CURR_ID"  >> $GITHUB_OUTPUT
          echo "Decision: needs_new=$NEEDS_NEW"

      - name: Attempt to create new global chain (with full response)
        if: steps.decide.outputs.needs_new == 'true'
        id: create
        run: |
          set -e
          echo "üì° Attempting to create a new global chain..."
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST "$SUPABASE_URL/rest/v1/chains" \
            -H "apikey: $SERVICE_KEY" \
            -H "Authorization: Bearer $SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            --data '{"type":"global","max_clips":null,"creator_id":null,"active":true}')
          STATUS=$(tail -n1 response.txt)
          echo "HTTP status: $STATUS"
          echo "‚úÖ Response body:"
          cat response.txt
          if [ "$STATUS" -ge 400 ]; then
            echo "‚ùå Chain creation failed with status $STATUS"
            exit 1
          fi
          echo "‚úÖ Chain creation successful."

      - name: Deactivate older chains (keep only the latest)
        run: |
          set -e
          echo "üßπ Deactivating older chains..."
          ACTIVE_CHAIN=$(curl -fsS \
            "$SUPABASE_URL/rest/v1/chains?type=eq.global&order=created_at.desc&limit=1" \
            -H "apikey: $SERVICE_KEY" \
            -H "Authorization: Bearer $SERVICE_KEY" \
            -H "Accept: application/json" )
          CHAIN_ID=$(echo "$ACTIVE_CHAIN" | grep -o '"id":"[^"]*"' | head -1 | cut -d':' -f2 | tr -d '"')
          echo "Latest chain id: $CHAIN_ID"
          if [ -n "$CHAIN_ID" ]; then
            curl -fsS -X PATCH \
              "$SUPABASE_URL/rest/v1/chains?type=eq.global&id=neq.$CHAIN_ID" \
              -H "apikey: $SERVICE_KEY" \
              -H "Authorization: Bearer $SERVICE_KEY" \
              -H "Content-Type: application/json" \
              -d '{"active": false}'
            echo "‚úÖ Older chains deactivated."
          else
            echo "‚ö†Ô∏è No chain ID found, skipping cleanup."
          fi
          exit 0
